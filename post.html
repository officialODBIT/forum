<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Create Post - ODBIT Forum</title>
<style>
  body { background: #0a0e24; color: white; font-family: Arial, sans-serif; padding: 20px; }
  textarea { width: 100%; height: 150px; background: #16203b; border: none; border-radius: 8px; color: white; padding: 12px; font-size: 16px; }
  button { margin-top: 12px; padding: 10px 20px; background: #1a4db7; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; }
  #logout { margin-bottom: 20px; cursor: pointer; color: #1a4db7; }
  a { color: #1a4db7; text-decoration: none; }
</style>
</head>
<body>

<div>
  <span id="logout">Logout</span> | <a href="discover.html">Back to Posts</a>
</div>

<h2>Create a Post</h2>
<textarea id="post-content" placeholder="Write something..."></textarea>
<br/>
<button id="submit-post">Submit Post</button>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
  import { getFirestore, doc, getDoc, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAe75TIxaH5ZJNJMi5UhDO16RnPoW4EeY4",
    authDomain: "odbit-forum.firebaseapp.com",
    projectId: "odbit-forum",
    storageBucket: "odbit-forum.firebasestorage.app",
    messagingSenderId: "473744036472",
    appId: "1:473744036472:web:b910368374b5d120e0538d"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const logoutBtn = document.getElementById("logout");
  const submitBtn = document.getElementById("submit-post");
  const textarea = document.getElementById("post-content");

  logoutBtn.onclick = () => {
    signOut(auth);
    window.location.href = "signin.html";
  };

  // Curse words list - add your own
  const badWords = ["badword1", "badword2", "curse"];

  let currentUser;

  onAuthStateChanged(auth, (user) => {
    if (!user) {
      window.location.href = "signin.html";
      return;
    }
    currentUser = user;
  });

  submitBtn.onclick = async () => {
    if (!currentUser) return alert("Not authenticated.");

    const postContent = textarea.value.trim();
    if (!postContent) return alert("Post cannot be empty.");

    const userDocRef = doc(db, "users", currentUser.uid);
    const userDoc = await getDoc(userDocRef);
    if (!userDoc.exists()) return alert("User data not found.");

    const { time = 0, likes = 0 } = userDoc.data();

    // Posting restrictions
    if (time < 10 || likes < 10) {
      return alert("You must have at least 10 minutes on site and 10 profile likes to post.");
    }

    // Censorship tier check
    let censoredContent = postContent;
    const needsCensorship = (time < 25 || likes < 25);
    if (needsCensorship) {
      const lower = postContent.toLowerCase();
      const foundBad = badWords.some(word => lower.includes(word));
      if (foundBad) {
        censoredContent = "Post is censored due to 1st teir requirements and attempting to post a inappropriate word.";
      }
    }

    try {
      await addDoc(collection(db, "posts"), {
        uid: currentUser.uid,
        content: censoredContent,
        createdAt: serverTimestamp(),
        isReply: false
      });
      alert("Post submitted!");
      textarea.value = "";
      window.location.href = "discover.html";
    } catch (err) {
      alert("Error submitting post: " + err.message);
    }
  };
</script>

</body>
</html>
